{"version":3,"sources":["src/index.js"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["import { ApolloLink } from 'apollo-link';\nimport React from 'react';\nimport decodeJWT from 'jwt-decode';\nimport hoinstStatics from 'hoist-non-react-statics';\n\nfunction decode(raw) {\n  try {\n    return decodeJWT(raw);\n  } catch (error) {\n    return null;\n  }\n}\n\nexport const subscribers = [];\n\n/**\n * @typedef {Object} Options apollo options options\n * @property {string} localStorageKey Key in the local storage to store jwt to\n */\n\nconst defaults = {\n  localStorageKey: '5cnasGf8fvJFB8WW2Uxrayc5',\n};\n\n/**\n * @typedef {Function} GraphQlLinkMiddleware handles graphql http response\n * @property {Object} GraphQlResponse in the local storage to store jwt to\n * @property {Object} GraphQlResponse.headers Server response headers\n */\n\n/**\n * @function handleResponse\n * @private\n * @param  {Options} values Config values\n * @return {GraphQlLinkMiddleware} Function that handles the response\n */\nfunction handleResponse(values) {\n  return (response) => {\n    const { headers = {} } = response;\n\n    const {\n      'X-Token-Create': xTokenCreate,\n      'X-Token-Update': xTokenUpdate,\n      'X-Token-Remove': xTokenRemove,\n    } = headers;\n\n    if (xTokenCreate || xTokenUpdate) {\n      localStorage.setItem(values.localStorageKey, xTokenCreate || xTokenUpdate);\n      subscribers.forEach((s) => s(decode(`${xTokenCreate || xTokenUpdate}`.replace('Bearer ', ''))));\n    }\n\n    if (xTokenRemove) {\n      localStorage.removeItem(values.localStorageKey);\n      subscribers.forEach((s) => s(null));\n    }\n\n    return response;\n  };\n}\n\n/**\n * @function createAuthManagerLink\n * @param  {type} options {description}\n * @return {GraphLink} Returns a manager link\n */\nexport function createAuthManagerLink() {\n  const values = {\n    ...defaults,\n  };\n\n  return new ApolloLink((operation, forward) => {\n    operation.setContext(({ headers = {} }) => ({\n      headers: {\n        ...headers,\n        authorization: localStorage.getItem(values.localStorageKey) || null,\n      },\n    }));\n\n    return forward(operation).map(handleResponse(values));\n  });\n}\n\n/**\n * @function createWsParams\n * @param  {Object|Function<Object|Promise<Object>>} partialParams WS params\n * @param  {Options} options User options\n * @return {Object} Ws Connection Params\n * @description Make `lazy: true` in WsLink options\n */\nexport async function createWsParams(partialParams = {}, options) {\n  /* eslint-disable no-param-reassign */\n\n  const values = {\n    ...defaults,\n    options,\n  };\n\n  if (typeof partialParams === 'function') {\n    partialParams = partialParams();\n  }\n\n  if (typeof partialParams.then === 'function') {\n    partialParams = await partialParams;\n  }\n\n  return {\n    ...partialParams,\n    authorization: localStorage.getItem(values.localStorageKey) || null,\n  };\n}\n\nconst AuthContext = React.createContext();\n\nexport class AuthProvider extends React.Component {\n  constructor(props) {\n    super(props);\n\n    const decoded = decode(localStorage.getItem(defaults.localStorageKey));\n\n    this.state = {\n      hasAuth: !!decoded,\n      user: decoded,\n    };\n\n    this.handleUpdate = this.handleUpdate.bind(this);\n  }\n\n  componentDidMount() {\n    subscribers.push(this.handleUpdate);\n  }\n\n  handleUpdate(decoded) {\n    if (this.timeout) {\n      clearTimeout(this.timeout);\n      this.timeout = null;\n    }\n\n    if (decoded) {\n      const { exp } = decoded;\n\n      const now = Math.round(Date.now() / 1000);\n      const diff = exp - now;\n\n      if (diff <= 0) {\n        this.handleUpdate(null);\n        return;\n      }\n\n      if (diff > 0 && diff < 3600) {\n        setTimeout(() => this.handleUpdate(null), diff * 1000);\n      }\n\n      this.setState({\n        hasAuth: true,\n        user: decoded,\n      });\n\n      return;\n    }\n\n    localStorage.removeItem(defaults.localStorageKey);\n\n    this.setState({\n      hasAuth: false,\n      user: null,\n    });\n  }\n\n  render() {\n    const { hasAuth, user } = this.state;\n    const { children } = this.props;\n\n    return React.createElement(AuthContext.Provider, {\n      value: {\n        hasAuth,\n        user,\n      },\n    }, children);\n  }\n}\n\nconst { Consumer: AuthConsumer } = AuthContext;\n\nexport function withAuth(UserComponent) {\n  function CustomComponent(props) {\n    return React.createElement(\n      AuthConsumer,\n      {},\n      // eslint-disable-next-line prefer-arrow-callback\n      function renderer(values) {\n        return React.createElement(UserComponent, { ...props, ...values });\n      },\n    );\n  }\n\n  hoinstStatics(CustomComponent, UserComponent);\n\n  CustomComponent.displayName = `withAuth(${UserComponent.displayName || UserComponent.name})`;\n\n  return CustomComponent;\n}\n\nexport { AuthConsumer };\n"]}